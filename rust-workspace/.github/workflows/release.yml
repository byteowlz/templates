name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always
  # TODO: Replace with your binary name
  BINARY_NAME: your-binary-name

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            features: ""
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            cross: true
            features: ""
          # macOS Intel
          - target: x86_64-apple-darwin
            os: macos-13
            features: ""
          # macOS Apple Silicon
          - target: aarch64-apple-darwin
            os: macos-14
            features: ""
            # Uncomment if you have CoreML acceleration:
            # features: "--features coreml"
          # Windows
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            features: ""

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross
        if: matrix.cross
        uses: taiki-e/install-action@cross

      - name: Build
        shell: bash
        run: |
          if [ "${{ matrix.cross }}" = "true" ]; then
            cross build --release --target ${{ matrix.target }} ${{ matrix.features }}
          else
            cargo build --release --target ${{ matrix.target }} ${{ matrix.features }}
          fi

      - name: Package (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          cd target/${{ matrix.target }}/release
          tar czvf ../../../${{ env.BINARY_NAME }}-${{ github.ref_name }}-${{ matrix.target }}.tar.gz ${{ env.BINARY_NAME }}

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd target/${{ matrix.target }}/release
          7z a ../../../${{ env.BINARY_NAME }}-${{ github.ref_name }}-${{ matrix.target }}.zip ${{ env.BINARY_NAME }}.exe

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BINARY_NAME }}-${{ matrix.target }}
          path: ${{ env.BINARY_NAME }}-${{ github.ref_name }}-${{ matrix.target }}.*

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate checksums
        run: |
          cd artifacts
          find . -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec mv {} . \;
          sha256sum *.tar.gz *.zip > checksums.txt

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            artifacts/*.tar.gz
            artifacts/*.zip
            artifacts/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # === Package Manager Publishing ===
  # Uncomment the sections below to enable automatic publishing.
  # Required secrets: TAP_GITHUB_TOKEN, AUR_SSH_PRIVATE_KEY, AUR_EMAIL

  # publish-homebrew:
  #   name: Publish to Homebrew
  #   needs: release
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Update Homebrew tap
  #       uses: peter-evans/repository-dispatch@v3
  #       with:
  #         token: ${{ secrets.TAP_GITHUB_TOKEN }}
  #         repository: byteowlz/homebrew-tap
  #         event-type: update-formula
  #         client-payload: |
  #           {
  #             "formula": "${{ env.BINARY_NAME }}",
  #             "version": "${{ github.ref_name }}",
  #             "repo": "${{ github.repository }}"
  #           }

  # publish-aur:
  #   name: Publish to AUR
  #   needs: release
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Generate PKGBUILD
  #       run: |
  #         VERSION="${{ github.ref_name }}"
  #         VERSION="${VERSION#v}"
  #         curl -sL "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/checksums.txt" -o checksums.txt
  #         SHA256=$(grep "x86_64-unknown-linux-gnu.tar.gz" checksums.txt | cut -d' ' -f1)
  #         cat > PKGBUILD << EOF
  #         # Maintainer: byteowlz
  #         pkgname=${{ env.BINARY_NAME }}
  #         pkgver=${VERSION}
  #         pkgrel=1
  #         pkgdesc="Your description here"
  #         arch=('x86_64')
  #         url="https://github.com/${{ github.repository }}"
  #         license=('MIT')
  #         depends=('gcc-libs')
  #         source=("\$pkgname-\$pkgver.tar.gz::https://github.com/${{ github.repository }}/releases/download/v\$pkgver/${{ env.BINARY_NAME }}-v\$pkgver-x86_64-unknown-linux-gnu.tar.gz")
  #         sha256sums=('${SHA256}')
  #         package() {
  #             install -Dm755 ${{ env.BINARY_NAME }} "\$pkgdir/usr/bin/${{ env.BINARY_NAME }}"
  #         }
  #         EOF
  #     - name: Publish to AUR
  #       uses: KSXGitHub/github-actions-deploy-aur@v3.0.1
  #       with:
  #         pkgname: ${{ env.BINARY_NAME }}
  #         pkgbuild: ./PKGBUILD
  #         commit_username: byteowlz
  #         commit_email: ${{ secrets.AUR_EMAIL }}
  #         ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
  #         commit_message: "Update to ${{ github.ref_name }}"

  # publish-scoop:
  #   name: Publish to Scoop
  #   needs: release
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Update Scoop bucket
  #       uses: peter-evans/repository-dispatch@v3
  #       with:
  #         token: ${{ secrets.TAP_GITHUB_TOKEN }}
  #         repository: byteowlz/scoop-bucket
  #         event-type: update-manifest
  #         client-payload: |
  #           {
  #             "name": "${{ env.BINARY_NAME }}",
  #             "version": "${{ github.ref_name }}",
  #             "repo": "${{ github.repository }}"
  #           }
